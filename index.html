<!doctype html>
<html lang="zh-CN" data-theme="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Todo Â· çº¯å‰ç«¯å¯æŒä¹…åŒ–</title>
  <meta name="description" content="é›¶ä¾èµ–çš„å‰ç«¯ TodoListï¼šæœ¬åœ°æŒä¹…åŒ–ã€æ‹–æ‹½æ’åºã€å›æ”¶ç«™ã€å¯¼å…¥å¯¼å‡ºã€æš—è‰²æ¨¡å¼" />
  <meta name="theme-color" content="#2563eb" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='256' height='256'%3E%3Crect width='256' height='256' fill='%232563eb'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='160' fill='white'%3E%E2%9C%93%3C/text%3E%3C/svg%3E" />
  <style>
    :root{
      --bg: #f6f7f9;
      --surface:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#2563eb;
      --accent-fg:#ffffff;
      --danger:#ef4444;
      --warn:#f59e0b;
      --ok:#16a34a;
      --shadow: 0 6px 24px rgba(0,0,0,.06), 0 2px 8px rgba(0,0,0,.04);
      --radius:12px;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b0e14;
        --surface:#11151c;
        --text:#e5e7eb;
        --muted:#98a2b3;
        --border:#1f2937;
        --accent:#3b82f6;
        --accent-fg:#0b0e14;
        --shadow: 0 6px 24px rgba(0,0,0,.45), 0 2px 8px rgba(0,0,0,.35);
      }
    }
    html[data-theme="light"]{ color-scheme: light; }
    html[data-theme="dark"]{
      color-scheme: dark;
      --bg:#0b0e14; --surface:#11151c; --text:#e5e7eb; --muted:#98a2b3;
      --border:#1f2937; --accent:#3b82f6; --accent-fg:#0b0e14; --shadow: 0 6px 24px rgba(0,0,0,.45), 0 2px 8px rgba(0,0,0,.35);
    }

    *{ box-sizing: border-box; }
    body{
      margin:0; font: 15px/1.4 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans","PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
      background:var(--bg); color:var(--text);
    }
    .container{ max-width: 920px; margin: 24px auto; padding: 0 16px; }
    .topbar{
      display:flex; align-items:center; gap:12px; justify-content:space-between; margin-bottom:16px;
    }
    .brand{ display:flex; align-items:center; gap:10px; }
    .brand .logo{ width:36px; height:36px; display:grid; place-items:center; border-radius:10px; background:var(--accent); color:var(--accent-fg); box-shadow: var(--shadow); font-weight:700; }
    .top-actions{ display:flex; gap:8px; align-items:center; }
    .btn{
      appearance:none; border:1px solid var(--border); background:var(--surface);
      color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer; transition:.2s;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: var(--shadow); }
    .btn.primary{ background:var(--accent); color:var(--accent-fg); border-color:transparent; }
    .btn.ghost{ background:transparent; border-color:var(--border); }
    .btn.danger{ background: var(--danger); color:#fff; border-color: transparent; }
    .btn.small{ padding:6px 10px; border-radius:8px; font-size: 13px; }
    .badge{ display:inline-flex; align-items:center; gap:6px; background:var(--surface); border:1px solid var(--border); padding:6px 10px; border-radius:999px; color:var(--muted); }

    .card{
      background:var(--surface); border:1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow);
    }

    .composer{ padding:14px; display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .composer input[type="text"]{
      flex:1 1 420px; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:transparent; color:var(--text);
      outline:none;
    }
    .composer input[type="date"], .composer input[type="time"], .composer select{
      padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:transparent; color:var(--text);
    }

    .filters{
      margin-top:10px; padding:10px 12px; display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between;
    }
    .filter-left, .filter-right{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .seg{ display:flex; background:var(--surface); border:1px solid var(--border); padding:4px; border-radius:12px; }
    .seg button{ border:none; background:transparent; padding:8px 12px; border-radius:8px; cursor:pointer; color:var(--muted); }
    .seg button.active{ background:var(--accent); color:var(--accent-fg); }

    #search{ padding:9px 12px; border-radius:10px; border:1px solid var(--border); background:transparent; color:var(--text); min-width: 200px; }

    .list{ margin-top:14px; padding:8px; }
    .todo{ display:flex; align-items:flex-start; gap:10px; padding:12px; border:1px solid var(--border); border-radius:12px; background:var(--surface); margin:8px 0; box-shadow: var(--shadow); }
    .todo.dragging{ opacity:.6; }
    .drag-handle{ cursor:grab; user-select:none; padding:4px 6px; border-radius:8px; color:var(--muted); }
    .todo:hover .drag-handle{ background: rgba(127,127,127,.08); }
    .check{ display:grid; place-items:center; }
    .check input{ width:20px; height:20px; }

    .content{ flex:1; min-width: 180px; }
    .title[contenteditable="true"]{
      outline:none; border-radius:8px; padding:2px 4px; line-height: 1.4;
    }
    .title:focus{ box-shadow: 0 0 0 2px rgba(37,99,235,.35); background: rgba(37,99,235,.06); }
    .todo.done .title{ text-decoration: line-through; color:var(--muted); }
    .meta{ margin-top:6px; display:flex; gap:10px; flex-wrap:wrap; font-size:13px; color:var(--muted); }
    .meta .chip{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:transparent; }
    .chip.overdue{ color:#fff; background: var(--danger); border-color: transparent; }
    .chip.due-soon{ background: rgba(245, 158, 11, .18); color:#fbbf24; border-color: transparent; }
    .chip.ok{ background: rgba(22,163,74,.18); color:#34d399; border-color: transparent; }
    .chip.pinned{ background: rgba(59,130,246,.18); color:#60a5fa; border-color: transparent; }

    .ops{ display:flex; gap:6px; align-items:center; }
    .ops .btn.small{ white-space:nowrap; }
    .muted{ color:var(--muted); }

    .empty{ text-align:center; color:var(--muted); padding:36px 12px; }
    .footer{ display:flex; justify-content:space-between; align-items:center; padding:16px 14px; color:var(--muted); }

    @media (max-width:640px){
      .composer{ gap:6px; }
      .composer input[type="text"]{ flex-basis: 100%; }
      #search{ min-width: 120px; flex: 1; }
      .filters{ gap:8px; }
    }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
	/* è®©ä»»ä½•å¸¦ hidden å±æ€§çš„å…ƒç´ éƒ½å¼ºåˆ¶éšè—ï¼Œé¿å…è¢«å…¶ä»–æ ·å¼è¦†ç›– */
[hidden] { display: none !important; }

  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <div class="logo">âœ“</div>
        <div>
          <div style="font-weight:700">å¾…åŠæ¸…å•</div>
          <div class="muted" style="font-size:12px;">çº¯å‰ç«¯ Â· æœ¬åœ°æŒä¹…åŒ– Â· GitHub Pages</div>
        </div>
      </div>
      <div class="top-actions">
        <button id="themeToggle" class="btn ghost" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ“ ä¸»é¢˜</button>
        <button id="exportBtn" class="btn ghost" title="å¯¼å‡ºå¤‡ä»½">ğŸ—‚ï¸ å¯¼å‡º</button>
        <button id="importBtn" class="btn ghost" title="å¯¼å…¥å¤‡ä»½">â¬†ï¸ å¯¼å…¥</button>
        <input id="importFile" type="file" accept="application/json" class="sr-only" />
      </div>
    </div>

    <div class="card composer" role="form" aria-label="æ·»åŠ ä»»åŠ¡">
      <input id="newTitle" type="text" placeholder="å†™ç‚¹å•¥â€¦ å›è½¦æ·»åŠ ï¼ˆä¾‹ï¼šç»™é¡¹ç›®å†™ READMEï¼‰" autocomplete="off" />
      <input id="newDate" type="date" />
      <input id="newTime" type="time" />
      <select id="newPriority" title="ä¼˜å…ˆçº§">
        <option value="normal" selected>ä¼˜å…ˆçº§ï¼šæ™®é€š</option>
        <option value="high">ä¼˜å…ˆçº§ï¼šé«˜</option>
        <option value="low">ä¼˜å…ˆçº§ï¼šä½</option>
      </select>
      <button id="addBtn" class="btn primary">æ·»åŠ </button>
    </div>

    <div class="card filters">
      <div class="filter-left">
        <div class="seg" role="tablist" aria-label="ç­›é€‰">
          <button data-filter="all" class="active" role="tab" aria-selected="true">å…¨éƒ¨</button>
          <button data-filter="active" role="tab" aria-selected="false">è¿›è¡Œä¸­</button>
          <button data-filter="done" role="tab" aria-selected="false">å·²å®Œæˆ</button>
          <button data-filter="trash" role="tab" aria-selected="false">å›æ”¶ç«™</button>
        </div>
        <span class="badge" id="counts">0 é¡¹</span>
      </div>
      <div class="filter-right">
        <input id="search" type="search" placeholder="æœç´¢ï¼ˆ/ å¿«æ·é”®ï¼‰" />
        <button id="emptyTrash" class="btn small danger" title="æ°¸ä¹…åˆ é™¤å›æ”¶ç«™å†…å®¹">æ¸…ç©ºå›æ”¶ç«™</button>
      </div>
    </div>

    <div class="list" id="list" aria-live="polite"></div>
    <div id="empty" class="empty muted">æ²¡æœ‰ä»»åŠ¡ã€‚æ·»åŠ ä¸€ä¸ªè¯•è¯•å§ âœ¨</div>

    <div class="card footer">
      <div>æ•°æ®ä¿å­˜åœ¨ä½ çš„æµè§ˆå™¨ï¼ˆlocalStorageï¼‰ã€‚åªæœ‰ä½ æ‰‹åŠ¨æ¸…ç©ºå›æ”¶ç«™æ‰ä¼šçœŸæ­£åˆ é™¤ã€‚</div>
      <div id="version" class="muted"></div>
    </div>
  </div>

  <template id="tpl">
    <div class="todo" draggable="true">
      <div class="drag-handle" title="æ‹–æ‹½æ’åº" aria-hidden="true">â‹®â‹®</div>
      <label class="check"><input class="toggle" type="checkbox" aria-label="å®Œæˆ" /></label>
      <div class="content">
        <div class="title" contenteditable="true" role="textbox" aria-label="ç¼–è¾‘ä»»åŠ¡æ ‡é¢˜"></div>
        <div class="meta">
          <span class="chip due"><span class="when">æ— æˆªæ­¢</span></span>
          <span class="chip prio">ä¼˜å…ˆçº§ï¼šæ™®é€š</span>
          <span class="chip pinned" hidden>å·²ç½®é¡¶</span>
          <span class="chip doneAt" hidden><span class="done-when">å®Œæˆæ—¶é—´</span></span>
          <span class="age muted"></span>
        </div>
      </div>
      <div class="ops">
        <button class="btn small pin" title="ç½®é¡¶/å–æ¶ˆç½®é¡¶">ğŸ“Œ</button>
        <button class="btn small schedule" title="è®¾ç½®/æ¸…é™¤æˆªæ­¢">â°</button>
        <button class="btn small del" title="åˆ é™¤ï¼ˆç§»å…¥å›æ”¶ç«™ï¼‰">ğŸ—‘ï¸</button>
        <button class="btn small restore" title="è¿˜åŸ" hidden>â†©ï¸</button>
      </div>
    </div>
  </template>

  <script>
    "use strict";

    // ====== å·¥å…· & DOM ======
    const must = (sel) => {
      const el = document.querySelector(sel);
      if (!el) { console.error("æœªæ‰¾åˆ°å…ƒç´ ï¼š", sel); throw new Error("ç¼ºå°‘å¿…è¦çš„ DOMï¼š" + sel); }
      return el;
    };
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));
    const STORAGE_KEY = "todo.v2";
    const THEME_KEY = "todo.theme";
    const APP_VERSION = "1.1.0 (å®Œæˆæ—¶é—´)";

    const uid = () => (crypto?.randomUUID?.() ?? (`id-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`));
    const safeParse = (raw, fallback) => { try { return JSON.parse(raw); } catch { return fallback; } };

    const refs = {
      list: must("#list"),
      empty: must("#empty"),
      newTitle: must("#newTitle"),
      newDate: must("#newDate"),
      newTime: must("#newTime"),
      newPriority: must("#newPriority"),
      addBtn: must("#addBtn"),
      counts: must("#counts"),
      filterTabs: must(".filters .seg"),
      search: must("#search"),
      emptyTrash: must("#emptyTrash"),
      importBtn: must("#importBtn"),
      importFile: must("#importFile"),
      exportBtn: must("#exportBtn"),
      themeToggle: must("#themeToggle"),
      tpl: must("#tpl"),
      version: must("#version"),
    };

    // ====== çŠ¶æ€åˆå§‹åŒ– ======
    const defaultState = () => ({ version: 2, nextOrder: 1, todos: [] });
    let state = (() => {
      const raw = localStorage.getItem(STORAGE_KEY);
      const d = safeParse(raw, defaultState());
      if (!d || !Array.isArray(d.todos)) return defaultState();
      for (const t of d.todos) {
        if (!t.id) t.id = uid();
        if (typeof t.done !== "boolean") t.done = false;
        if (t.deletedAt == null) t.deletedAt = null;
        if (t.pinned == null) t.pinned = false;
        if (!("order" in t)) t.order = d.nextOrder || 1;
        if (!("priority" in t)) t.priority = "normal";
        if (!("completedAt" in t)) t.completedAt = null; // å…¼å®¹æ—§æ•°æ®
      }
      if (!("nextOrder" in d)) d.nextOrder = d.todos.length + 1;
      return d;
    })();

    function persist() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error("[ä¿å­˜å¤±è´¥]", e);
        alert("âš ï¸ æ— æ³•å†™å…¥æœ¬åœ°å­˜å‚¨ï¼šå¯èƒ½åœ¨æ— ç—•æ¨¡å¼ã€æƒé™å—é™æˆ–é…é¢å·²æ»¡ã€‚");
      }
    }

    // ====== ä¸»é¢˜ ======
    (function initTheme(){
      const saved = localStorage.getItem(THEME_KEY) || "auto";
      document.documentElement.setAttribute("data-theme", saved);
      refs.themeToggle.addEventListener("click", () => {
        const cur = document.documentElement.getAttribute("data-theme") || "auto";
        const next = cur === "auto" ? "dark" : (cur === "dark" ? "light" : "auto");
        document.documentElement.setAttribute("data-theme", next);
        localStorage.setItem(THEME_KEY, next);
      });
    })();

    // ====== æ—¶é—´æ ¼å¼å·¥å…· ======
    const nowMs = () => Date.now();
    const fmtDate = (ts) => {
      if (!ts) return "æ— æˆªæ­¢";
      const d = new Date(ts);
      const f = new Intl.DateTimeFormat(undefined, { month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
      return f.format(d);
    };
    const fmtDateTimeWithWeekday = (ts) => {
      if (!ts) return "";
      const d = new Date(ts);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const hm = new Intl.DateTimeFormat("zh-CN", { hour:"2-digit", minute:"2-digit", hour12:false }).format(d);
      const wk = new Intl.DateTimeFormat("zh-CN", { weekday:"short" }).format(d); // å‘¨ä¸€/å‘¨äºŒ...
      return `${yyyy}-${mm}-${dd} (${wk}) ${hm}`;
    };

    // ====== è¾“å…¥å–å€¼ ======
    const getDueFromInputs = () => {
      const d = refs.newDate.value;
      const t = refs.newTime.value;
      if (!d && !t) return null;
      const dateStr = d || new Date().toISOString().slice(0,10);
      const timeStr = t || "00:00";
      const dt = new Date(`${dateStr}T${timeStr}`);
      const ms = dt.getTime();
      return Number.isFinite(ms) ? ms : null;
    };

    // ====== ARIA announcer ======
    const announcer = document.createElement("div");
    announcer.className = "sr-only";
    announcer.setAttribute("role", "status");
    announcer.setAttribute("aria-live","polite");
    document.body.appendChild(announcer);
    const announce = (msg) => { announcer.textContent = msg; };

    // ====== è¿‡æ»¤ & æœç´¢ ======
    let filter = "all"; // all | active | done | trash
    function sortForDisplay(arr){
      if (filter === "trash") return arr.slice().sort((a,b)=> (b.deletedAt ?? 0) - (a.deletedAt ?? 0));
      return arr.slice().sort((a,b)=> (b.pinned - a.pinned) || (a.order - b.order));
    }
    function filtered(){
      const q = refs.search.value.trim().toLowerCase();
      let list = state.todos.filter(t => {
        if (filter === "active") return !t.deletedAt && !t.done;
        if (filter === "done")   return !t.deletedAt &&  t.done;
        if (filter === "trash")  return  t.deletedAt;
        return !t.deletedAt;
      });
      if (q) list = list.filter(t => t.text.toLowerCase().includes(q));
      return sortForDisplay(list);
    }
    function updateCounts(){
      const all = state.todos.filter(t => !t.deletedAt).length;
      const active = state.todos.filter(t => !t.deletedAt && !t.done).length;
      const done = state.todos.filter(t => !t.deletedAt && t.done).length;
      const trash = state.todos.filter(t => t.deletedAt).length;
      refs.counts.textContent = `å…¨éƒ¨ ${all} Â· è¿›è¡Œä¸­ ${active} Â· å·²å®Œæˆ ${done} Â· å›æ”¶ç«™ ${trash}`;
    }

    // ====== æ¸²æŸ“ ======
    function setDueChip(el, todo){
      const chip = el.querySelector(".chip.due");
      const label = chip.querySelector(".when");
      label.textContent = fmtDate(todo.dueAt);
      chip.classList.remove("overdue","due-soon","ok");
      if (!todo.dueAt) return;
      const diffHrs = (todo.dueAt - nowMs()) / 3600000;
      if (diffHrs < 0) chip.classList.add("overdue");
      else if (diffHrs <= 24) chip.classList.add("due-soon");
      else chip.classList.add("ok");
    }
    function setPrioChip(el, todo){
      el.querySelector(".chip.prio").textContent = `ä¼˜å…ˆçº§ï¼š${todo.priority === "high" ? "é«˜" : todo.priority === "low" ? "ä½" : "æ™®é€š"}`;
    }
    function setPinnedChip(el, todo){
      el.querySelector(".chip.pinned").hidden = !todo.pinned;
    }
    function setAge(el, todo){
      const days = Math.floor((nowMs() - todo.createdAt)/86400000);
      el.querySelector(".age").textContent = days <= 0 ? "ä»Šå¤©åˆ›å»º" : `${days} å¤©å‰åˆ›å»º`;
    }
    function setDoneAtChip(el, todo){
      const chip = el.querySelector(".chip.doneAt");
      const span = el.querySelector(".chip.doneAt .done-when");
      const has = !!todo.completedAt && !!todo.done;
      chip.hidden = !has;
      if (has) span.textContent = `å®Œæˆï¼š${fmtDateTimeWithWeekday(todo.completedAt)}`;
    }

    function render(){
      const data = filtered();
      refs.list.innerHTML = "";
      for (const todo of data) {
        const node = refs.tpl.content.firstElementChild.cloneNode(true);
        node.dataset.id = todo.id;
        node.querySelector(".toggle").checked = !!todo.done;
        node.querySelector(".title").textContent = todo.text;
        node.classList.toggle("done", !!todo.done);
        setDueChip(node, todo);
        setPrioChip(node, todo);
        setPinnedChip(node, todo);
        setDoneAtChip(node, todo);
        setAge(node, todo);

        const inTrash = !!todo.deletedAt;
        const delBtn = node.querySelector(".del");
        delBtn.textContent = inTrash ? "åˆ é™¤" : "ğŸ—‘ï¸";
        delBtn.title = inTrash ? "æ°¸ä¹…åˆ é™¤" : "åˆ é™¤ï¼ˆç§»å…¥å›æ”¶ç«™ï¼‰";
        node.querySelector(".restore").hidden = !inTrash;
        node.setAttribute("draggable", (!inTrash && filter !== "trash"));

        refs.list.appendChild(node);
      }
      refs.empty.hidden = data.length > 0;
      updateCounts();
    }

    // ====== æ·»åŠ ä»»åŠ¡ ======
    function addTodo(){
      const title = refs.newTitle.value.trim();
      if (!title) { alert("è¯·å…ˆè¾“å…¥ä»»åŠ¡æ ‡é¢˜å†æ·»åŠ ã€‚"); refs.newTitle.focus(); return; }
      const now = Date.now();
      const todo = {
        id: uid(),
        text: title,
        done: false,
        createdAt: now,
        updatedAt: now,
        dueAt: getDueFromInputs(),
        priority: refs.newPriority.value || "normal",
        deletedAt: null,
        pinned: false,
        order: state.nextOrder++,
        completedAt: null, // æ–°å­—æ®µ
      };
      state.todos.push(todo);
      refs.newTitle.value = "";
      refs.newDate.value = "";
      refs.newTime.value = "";
      refs.newPriority.value = "normal";
      persist();
      render();
      announce("å·²æ·»åŠ ä»»åŠ¡");
    }

    // ====== äº‹ä»¶ç»‘å®š ======
    refs.addBtn.addEventListener("click", addTodo);
    refs.newTitle.addEventListener("keydown", (e)=>{
      if (e.key === "Enter") { e.preventDefault(); addTodo(); }
      else if (e.key === "Escape") { e.currentTarget.blur(); }
    });

    window.addEventListener("keydown", (e)=>{
      if (e.key === "/" && document.activeElement !== refs.search && !/input|textarea/i.test(document.activeElement?.tagName)) {
        e.preventDefault(); refs.search.focus();
      }
    });

    refs.filterTabs.addEventListener("click", (e)=>{
      if (e.target.matches("button[data-filter]")) {
        $$(".filters .seg button").forEach(b => b.classList.remove("active"));
        e.target.classList.add("active");
        filter = e.target.dataset.filter;
        render();
      }
    });
    refs.search.addEventListener("input", render);

    // åˆ—è¡¨äº¤äº’
    refs.list.addEventListener("change", (e)=>{
      const row = e.target.closest(".todo"); if (!row) return;
      const todo = state.todos.find(t => t.id === row.dataset.id); if (!todo) return;
      if (e.target.matches(".toggle")) {
        const now = Date.now();
        const checked = !!e.target.checked;
        todo.done = checked;
        // å¦‚æœå¸Œæœ›æ¯æ¬¡å‹¾é€‰éƒ½åˆ·æ–°å®Œæˆæ—¶é—´ï¼ŒæŠŠä¸‹ä¸€è¡Œæ”¹æˆï¼štodo.completedAt = checked ? now : null;
        todo.completedAt = checked ? (todo.completedAt ?? now) : null;
        todo.updatedAt = now;
        persist(); render();
      }
    });
    refs.list.addEventListener("click", (e)=>{
      const row = e.target.closest(".todo"); if (!row) return;
      const todo = state.todos.find(t => t.id === row.dataset.id); if (!todo) return;

      if (e.target.matches(".pin")) {
        todo.pinned = !todo.pinned; todo.updatedAt = Date.now(); persist(); render();
      } else if (e.target.matches(".schedule")) {
        const val = prompt("è®¾ç½®æˆªæ­¢æ—¶é—´ï¼ˆYYYY-MM-DD æˆ– YYYY-MM-DD HH:mmï¼‰\nç•™ç©ºå¯æ¸…é™¤ï¼š",
          todo.dueAt ? new Date(todo.dueAt).toISOString().slice(0,16).replace("T"," ") : "");
        if (val === null) return;
        const s = val.trim();
        if (!s) todo.dueAt = null;
        else {
          const t = Date.parse(s.replace(" ","T"));
          if (Number.isFinite(t)) todo.dueAt = t;
          else alert("æ— æ³•è§£æè¿™ä¸ªæ—¥æœŸæ—¶é—´ï¼Œè¯·æŒ‰ç¤ºä¾‹æ ¼å¼ã€‚");
        }
        todo.updatedAt = Date.now(); persist(); render();
      } else if (e.target.matches(".del")) {
        if (todo.deletedAt) {
          if (confirm("ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™æ¡ä»»åŠ¡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚")) {
            state.todos = state.todos.filter(t => t.id !== todo.id);
          }
        } else {
          todo.deletedAt = Date.now();
        }
        persist(); render();
      } else if (e.target.matches(".restore")) {
        todo.deletedAt = null; todo.updatedAt = Date.now(); persist(); render();
      }
    });

    // è¡Œå†…ç¼–è¾‘
    refs.list.addEventListener("keydown", (e)=>{
      const title = e.target.closest(".title[contenteditable='true']");
      if (!title) return;
      if (e.key === "Enter") { e.preventDefault(); title.blur(); }
      if (e.key === "Escape") { document.execCommand?.("undo"); title.blur(); }
    });
    refs.list.addEventListener("blur", (e)=>{
      const title = e.target.closest(".title[contenteditable='true']");
      if (!title) return;
      const row = title.closest(".todo");
      const todo = state.todos.find(t => t.id === row.dataset.id);
      const newText = title.textContent.trim();
      if (todo && newText && newText !== todo.text) {
        todo.text = newText; todo.updatedAt = Date.now(); persist(); render();
      } else if (!newText) { title.textContent = todo?.text ?? ""; }
    }, true);

    // æ‹–æ‹½æ’åºï¼ˆä»…éå›æ”¶ç«™ï¼‰
    let draggingId = null;
    refs.list.addEventListener("dragstart", (e)=>{
      const row = e.target.closest(".todo");
      if (!row || filter === "trash") return;
      draggingId = row.dataset.id;
      row.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
    });
    refs.list.addEventListener("dragover", (e)=>{
      if (!draggingId) return;
      e.preventDefault();
      const container = refs.list;
      const after = getDragAfterElement(container, e.clientY);
      const draggingEl = container.querySelector(".todo.dragging");
      if (!draggingEl) return;
      if (after == null) container.appendChild(draggingEl);
      else container.insertBefore(draggingEl, after);
    });
    refs.list.addEventListener("drop", (e)=>{
      if (!draggingId) return;
      e.preventDefault();
      const ids = [...refs.list.querySelectorAll(".todo")].map(el => el.dataset.id);
      applyOrderFromIds(ids);
      const el = refs.list.querySelector(".todo.dragging");
      if (el) el.classList.remove("dragging");
      draggingId = null;
      persist(); render();
    });
    refs.list.addEventListener("dragend", ()=>{
      const el = refs.list.querySelector(".todo.dragging");
      if (el) el.classList.remove("dragging");
      draggingId = null;
    });
    function getDragAfterElement(container, y) {
      const items = [...container.querySelectorAll(".todo:not(.dragging)")];
      return items.reduce((closest, child)=>{
        const box = child.getBoundingClientRect();
        const offset = y - (box.top + box.height/2);
        if (offset < 0 && offset > closest.offset) {
          return { offset, element: child };
        } else return closest;
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }
    function applyOrderFromIds(ids){
      const visibleIds = new Set(filtered().map(t=>t.id));
      let base = Math.min(...state.todos.filter(t=>visibleIds.has(t.id)).map(t=>t.order));
      if (!Number.isFinite(base)) base = 0;
      ids.forEach((id, i)=>{
        const t = state.todos.find(x => x.id === id);
        if (t && visibleIds.has(id)) t.order = base + i;
      });
      state.todos.sort((a,b)=> (b.pinned - a.pinned) || (a.order - b.order));
    }

    // å¯¼å‡º / å¯¼å…¥
    refs.exportBtn.addEventListener("click", ()=>{
      const data = JSON.stringify(state, null, 2);
      const blob = new Blob([data], {type: "application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = `todolist-backup-${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=> URL.revokeObjectURL(url), 1000);
    });
    refs.importBtn.addEventListener("click", ()=> refs.importFile.click());
    refs.importFile.addEventListener("change", (e)=>{
      const file = e.target.files?.[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const incoming = JSON.parse(reader.result);
          if (!incoming || !Array.isArray(incoming.todos)) throw new Error("æ ¼å¼ä¸æ­£ç¡®");
          const seen = new Set(state.todos.map(t => t.id));
          for (const t of incoming.todos) {
            if (!t.id) t.id = uid();
            if (seen.has(t.id)) continue;
            // å…¼å®¹ç¼ºå°‘ completedAt çš„å¤‡ä»½
            if (!("completedAt" in t)) t.completedAt = null;
            state.todos.push(t);
            seen.add(t.id);
            state.nextOrder = Math.max(state.nextOrder, (t.order ?? 0) + 1);
          }
          persist(); render();
          alert("å¯¼å…¥å®Œæˆï¼ˆå·²ä¸ç°æœ‰ä»»åŠ¡åˆå¹¶ï¼‰ã€‚");
        } catch (err) {
          console.error("[å¯¼å…¥å¤±è´¥]", err);
          alert("å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®æˆ–å·²æŸåã€‚");
        } finally { e.target.value = ""; }
      };
      reader.readAsText(file, "utf-8");
    });

    // å›æ”¶ç«™æ¸…ç©º
    refs.emptyTrash.addEventListener("click", ()=>{
      const count = state.todos.filter(t=>t.deletedAt).length;
      if (!count) { alert("å›æ”¶ç«™ä¸ºç©ºã€‚"); return; }
      if (confirm(`æ°¸ä¹…åˆ é™¤å›æ”¶ç«™ä¸­çš„ ${count} æ¡ä»»åŠ¡ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
        state.todos = state.todos.filter(t=>!t.deletedAt);
        persist(); render();
      }
    });

    // åˆæ¬¡æ¸²æŸ“
    refs.version.textContent = `v${APP_VERSION}`;
    render();

    // PWAï¼ˆå¯é€‰ï¼‰ï¼šæ³¨å†Œ Service Worker
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js").catch(()=>{});
      });
    }
  </script>
</body>
</html>
